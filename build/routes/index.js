"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.routerHandle=exports.unProtectedRoutes=exports.protectedRoutes=void 0;const authentication_1=require("../authentication"),constants_1=require("../constants"),log_1=require("../log"),logger_1=require("../logger"),enums_1=require("../enums"),helpers_1=require("../helpers"),helper_1=require("./helper"),messages_1=require("../messages"),configuration_1=require("../configuration"),models_1=require("../models");var protected_1=require("./protected"),unProtected_1=(Object.defineProperty(exports,"protectedRoutes",{enumerable:!0,get:function(){return protected_1.protectedRoutes}}),require("./unProtected"));Object.defineProperty(exports,"unProtectedRoutes",{enumerable:!0,get:function(){return unProtected_1.unProtectedRoutes}});const querystring_1=__importDefault(require("querystring")),routerHandle=async(r,e)=>{(0,helper_1.firstInstall)(r),(0,helpers_1.createBearerToken)(r);var o=(0,helper_1.decodeUrl)(r);if(o){if(r.decodedUrl=o,constants_1._DEBUG,!o.service)throw new Error(messages_1.errors.noNameIdentified);if(o.service&&o.configName){r.config=configuration_1.serverConfig.getConfig(o.configName),o.version==r.config.apiVersion||"POST"===r.request.method&&r.originalUrl.includes(o.version+"/Loras")||r.redirect("GET"===r.request.method?r.originalUrl.replace(o.version,r.config.apiVersion):`${r.decodedUrl.linkbase}/v${r.config.apiVersion}/`),r.querystring=decodeURIComponent(querystring_1.default.unescape(r.querystring));try{r.config.extensions.includes(enums_1.EnumExtensions.logs)&&(r.log={datas:{...r.body},code:-999,method:r.method,url:r.url,database:r.config.pg.database,user_id:(0,helpers_1.getUserId)(r).toString()})}catch(e){r.log=void 0}r.model=models_1.models.filteredModelFromConfig(r.config);try{r.config&&(r.user=(0,authentication_1.decodeToken)(r),await e().then(async()=>{r.config.extensions.includes(enums_1.EnumExtensions.logs)&&await(0,logger_1.writeToLog)(r)}))}catch(e){log_1.log.errorMsg(e),r.config&&r.config.extensions.includes(enums_1.EnumExtensions.logs)&&(0,logger_1.writeToLog)(r,e);o={code:e.statusCode,message:e.message,detail:e.detail};r.status=e.statusCode||e.status||500,r.body=e.link?{...o,link:e.link}:o}}}else"/INFOS"===r.path.toLocaleUpperCase()&&(r.body=configuration_1.serverConfig.getAllInfos(r))};exports.routerHandle=routerHandle;