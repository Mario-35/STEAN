"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.protectedRoutes=void 0;const koa_router_1=__importDefault(require("koa-router")),dataAccess_1=require("../db/dataAccess"),helpers_1=require("../helpers"),fs_1=__importDefault(require("fs")),logger_1=require("../logger"),views_1=require("../views/"),odata_1=require("../odata"),messages_1=require("../messages"),enums_1=require("../enums"),authentication_1=require("../authentication"),constants_1=require("../constants"),helpers_2=require("../db/helpers"),configuration_1=require("../configuration"),helper_1=require("./helper"),views_2=require("../views"),helpers_3=require("../views/helpers");exports.protectedRoutes=new koa_router_1.default,exports.protectedRoutes.post("/(.*)",async(r,e)=>{switch(r.decodedUrl.path.toUpperCase()){case"LOGIN":return r.request.token&&r.redirect(r.decodedUrl.root+"/status"),void await(0,authentication_1.loginUser)(r).then(e=>{e?(r.status=200,r.request.header.accept&&r.request.header.accept.includes("text/html")?r.redirect(r.decodedUrl.root+"/Status"):r.body={message:messages_1.infos.loginOk,user:e.username,token:e.token}):r.throw(401)});case"REGISTER":var s={};if(""===r.body.username.trim()?s.username=(0,messages_1.msg)(messages_1.errors.empty,"username"):await(0,helpers_2.executeSqlValues)(configuration_1.serverConfig.getConfig(constants_1.ADMIN),`SELECT "username" FROM "user" WHERE username = '${r.body.username}' LIMIT 1`)&&(s.username=messages_1.errors.alreadyPresent),""===r.body.email.trim()?s.email=(0,messages_1.msg)(messages_1.errors.empty,"email"):!1===(0,helper_1.emailIsValid)(r.body.email)&&(s.email=(0,messages_1.msg)(messages_1.errors.invalid,"email")),""===r.body.password.trim()&&(s.password=(0,messages_1.msg)(messages_1.errors.empty,"password")),""===r.body.repeat.trim()?s.repeat=(0,messages_1.msg)(messages_1.errors.empty,"repeat password"):r.body.password!=r.body.repeat?s.repeat=messages_1.errors.passowrdDifferent:!1===(0,helper_1.checkPassword)(r.body.password)&&(s.password=(0,messages_1.msg)(messages_1.errors.invalid,"password")),0===Object.keys(s).length)try{await dataAccess_1.userAccess.post(r.config.name,r.body)}catch(e){r.redirect(r.decodedUrl.root+"/error")}else{s=new views_2.Login(r,{login:!1,body:r.request.body,why:s});r.type=helpers_1.returnFormats.html.type,r.body=s.toString()}return}var t,a;!r.decodedUrl.version&&"/"===r.decodedUrl.path&&"CREATE"===r.decodedUrl.service.toUpperCase()||(r.user&&0<r.user.id||!1===r.config.users||r.request.url.includes("/Lora")?r.request.type.startsWith("application/json")&&0<Object.keys(r.body).length?((t=await(0,odata_1.createOdata)(r))&&(r.odata=t),r.odata?(t=await new dataAccess_1.apiAccess(r).post())&&(helpers_1.returnFormats.json.type,r.status=201,r.body=t.body):r.throw(400)):r.request.type.startsWith("multipart/")?(r.datas=await new Promise(async(s,t)=>{await(0,helpers_1.upload)(r).then(e=>{s(e)}).catch(e=>{t(e.state="ERROR")})}),(t=await(0,odata_1.createOdata)(r))&&(r.odata=t),r.odata&&(t=await new dataAccess_1.apiAccess(r).post(),r.datas&&fs_1.default.unlinkSync(r.datas.file),t?"query"==r.datas.source?(a=await(0,helpers_3.createQueryParams)(r))&&(r.type="html",r.body=(0,views_1.createQueryHtml)({...a,results:JSON.stringify({added:t.total,value:t.body})})):(helpers_1.returnFormats.json.type,r.status=201,r.body=t.body):r.throw(400))):r.throw(400,{details:messages_1.errors.payloadIsMalformed}):r.throw(401))}),exports.protectedRoutes.patch("/(.*)",async e=>{var s;!0===(0,helpers_1.isAllowedTo)(e,enums_1.EnumUserRights.Post)&&0<Object.keys(e.body).length?((s=await(0,odata_1.createOdata)(e))&&(e.odata=s),e.odata?(s=new dataAccess_1.apiAccess(e),e.odata.id?(s=await s.update(e.odata.id))&&(helpers_1.returnFormats.json.type,e.status=200,e.body=s.body):e.throw(400,{detail:messages_1.errors.idRequired})):e.throw(404)):e.throw(401)}),exports.protectedRoutes.delete("/(.*)",async e=>{var s;!0===(0,helpers_1.isAllowedTo)(e,enums_1.EnumUserRights.Delete)?((s=await(0,odata_1.createOdata)(e))&&(e.odata=s),e.odata?(s=new dataAccess_1.apiAccess(e),e.odata.id||e.throw(400,{detail:messages_1.errors.idRequired}),(s=await s.delete(e.odata.id))&&s.id&&0<s.id?(helpers_1.returnFormats.json.type,e.status=204):e.throw(404,{code:404,detail:messages_1.errors.noId+e.odata.id})):e.throw(404)):e.throw(401)});