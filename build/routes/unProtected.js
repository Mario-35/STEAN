"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.unProtectedRoutes=void 0;const koa_router_1=__importDefault(require("koa-router")),authentication_1=require("../authentication"),constants_1=require("../constants"),helpers_1=require("../helpers"),dataAccess_1=require("../db/dataAccess"),logger_1=require("../logger"),views_1=require("../views/"),odata_1=require("../odata"),messages_1=require("../messages"),configuration_1=require("../configuration"),createDb_1=require("../db/createDb"),helpers_2=require("../db/helpers"),models_1=require("../models"),helper_1=require("./helper"),helpers_3=require("../db/helpers"),views_2=require("../views/"),helpers_4=require("../views/helpers");exports.unProtectedRoutes=new koa_router_1.default,exports.unProtectedRoutes.get("/(.*)",async t=>{switch(t.decodedUrl.path.toUpperCase()){case"/":return t.body=models_1.models.getRoot(t),void(t.type=helpers_1.returnFormats.json.type);case"ERROR":var e=new views_2.HtmlError(t,"what ?");return t.type=helpers_1.returnFormats.html.type,void(t.body=e.toString());case"EXPORT":return t.type=helpers_1.returnFormats.json.type,void(t.body=await(0,helpers_2.exportService)(t));case"LOGIN":return void((0,authentication_1.ensureAuthenticated)(t)?t.redirect(t.decodedUrl.root+"/status"):(e=new views_2.Login(t,{login:!0}),t.type=helpers_1.returnFormats.html.type,t.body=e.toString()));case"STATUS":if((0,authentication_1.ensureAuthenticated)(t)){var e=await(0,authentication_1.getAuthenticatedUser)(t);if(e)return e=new views_2.Status(t,e),t.type=helpers_1.returnFormats.html.type,void(t.body=e.toString())}return void t.redirect(t.decodedUrl.root+"/login");case"REGISTER":e=new views_2.Login(t,{login:!1});return t.type=helpers_1.returnFormats.html.type,void(t.body=e.toString());case"LOGOUT":return t.cookies.set("jwt-session"),t.request.header.accept&&t.request.header.accept.includes("text/html")?t.redirect(t.decodedUrl.root+"/login"):t.status=200,void(t.body={message:messages_1.infos.logoutOk});case"SQL":e=(0,helpers_1.getUrlKey)(t.request.url,"query");return void(e&&(e=atob(e),e=await(0,helpers_2.executeSql)(e.includes("log_request")?configuration_1.serverConfig.getConfig(constants_1.ADMIN):t.config,e),t.status=201,t.body=[e]));case"DRAW":return t.type=helpers_1.returnFormats.xml.type,void(t.body=models_1.models.getDraw(t));case"INFOS":return t.type=helpers_1.returnFormats.json.type,void(t.body=await models_1.models.getInfos(t));case"REDOAGRHYS":case"DROP":if(!0===t.config.canDrop||"REDOAGRHYS"==t.decodedUrl.path.toUpperCase()){const a="REDOAGRHYS"==t.decodedUrl.path.toUpperCase()?"agrhys":t.config.pg.database;await(0,helpers_2.executeAdmin)((0,helper_1.sqlStopDbName)((0,helpers_1.addSimpleQuotes)(a))).then(async()=>{await(0,helpers_2.executeAdmin)("DROP DATABASE IF EXISTS "+a);try{t.status=201,t.body=await(0,createDb_1.createDatabase)(a)}catch(e){t.status=400,t.redirect(t.decodedUrl.root+"/error")}})}return;case"CREATEDBTEST":try{t.body=await(0,helpers_3.createService)(createDb_1.testDatas),t.status=201}catch(e){t.status=400,t.redirect(t.decodedUrl.root+"/error")}return;case"REMOVEDBTEST":e=await configuration_1.serverConfig.connection(constants_1.ADMIN)`${(0,helper_1.sqlStopDbName)("test")}`.then(async()=>(await configuration_1.serverConfig.connection(constants_1.ADMIN)`DROP DATABASE IF EXISTS test`,!0));return void(e?(t.status=204,t.body=e):(t.status=400,t.redirect(t.decodedUrl.root+"/error")));case"QUERY":t.decodedUrl.service===constants_1.ADMIN&&!1===(0,helpers_1.isAdmin)(t)&&t.redirect(t.decodedUrl.root+"/login");e=await(0,helpers_4.createQueryParams)(t);return void(e&&(t.set("script-src","self"),t.set("Content-Security-Policy","self"),t.type=helpers_1.returnFormats.html.type,t.body=(0,views_1.createQueryHtml)(e)));case"OPTIONS":e=new views_2.Config(t,{login:!1,config:t.config,url:t.request.url});return t.type=helpers_1.returnFormats.html.type,void(t.body=e.toString())}var r,o;(t.decodedUrl.path.includes("/"+t.config.apiVersion)||t.decodedUrl.version)&&(r=await(0,odata_1.createOdata)(t))&&(t.odata=r,!0===t.odata.returnNull?t.body={values:[]}:(r=new dataAccess_1.apiAccess(t))&&(t.odata.entity&&0===Number(t.odata.id)?(o=await r.getAll())?(o=t.odata.returnFormat===helpers_1.returnFormats.json?{"@iot.count":o.id,"@iot.nextLink":o.nextLink,"@iot.prevLink":o.prevLink,value:o.body}:o.body,t.type=t.odata.returnFormat.type,t.body=t.odata.returnFormat.format(o,t)):t.throw(404):t.odata.id&&"bigint"==typeof t.odata.id&&0<t.odata.id||"string"==typeof t.odata.id&&""!=t.odata.id?(o=await r.getSingle(t.odata.id))&&o.body?(t.type=t.odata.returnFormat.type,t.body=t.odata.returnFormat.format(o.body)):t.throw(404,{detail:`id : ${t.odata.id} not found`}):t.throw(400)))});