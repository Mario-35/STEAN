"use strict";var Query,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=__importDefault(require("./utils")),lexer_1=__importDefault(require("./lexer")),primitiveLiteral_1=__importDefault(require("./primitiveLiteral")),nameOrIdentifier_1=__importDefault(require("./nameOrIdentifier")),expressions_1=__importDefault(require("./expressions")),helpers_1=require("../../helpers");!function(_){const u=(e,t,r)=>utils_1.default.equals(e,t,"%24"+r)?r.length+3:utils_1.default.equals(e,t,"$"+r)?r.length+1:void 0;_.queryOptions=function(e,t,r){let l=_.queryOption(e,t,r);if(l){for(var a=t,u=(t=l.next,[]);l&&(u.push(l),38===e[t]);){if(t++,!(l=_.queryOption(e,t,r)))return;t=l.next}return lexer_1.default.tokenize(e,a,t,{options:u},lexer_1.default.TokenType.QueryOptions)}},_.queryOption=function(e,t,r){return _.systemQueryOption(e,t,r)||_.aliasAndValue(e,t)||_.customQueryOption(e,t)},_.systemQueryOption=function(e,t,r){return _.expand(e,t,r)||_.filter(e,t)||_.format(e,t)||_.resultFormat(e,t)||_.splitResult(e,t)||_.interval(e,t)||_.payload(e,t)||_.id(e,t)||_.InlineCount(e,t)||_.orderby(e,t)||_.search(e,t)||_.select(e,t)||_.skip(e,t)||_.skiptoken(e,t)||_.top(e,t)||_.log(e,t)||_.debug(e,t)},_.customQueryOption=function(e,t){var r=nameOrIdentifier_1.default.odataIdentifier(e,t);if(r){var l=t,a=(t=r.next,lexer_1.default.EQ(e,t));if(a){for(t=a;38!==e[t]&&t<e.length;)t++;if(t!==a)return lexer_1.default.tokenize(e,l,t,{key:r.raw,value:utils_1.default.stringify(e,a,t)},lexer_1.default.TokenType.CustomQueryOption)}}},_.debug=function(e,t){var r=t,l=u(e,r,"debug");if(l){t+=l;l=lexer_1.default.EQ(e,t);if(l){t=l;l=primitiveLiteral_1.default.booleanValue(e,t);if(l)return t=l.next,lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.Debug)}}},_.splitResult=function(e,t){var r=t,l=u(e,r,"splitResult");if(l){t+=l;l=lexer_1.default.EQ(e,t);if(l){for(t=l;38!==e[t]&&t<e.length;)t++;if(t!==l)return lexer_1.default.tokenize(e,r,t,utils_1.default.stringify(e,l,t),lexer_1.default.TokenType.splitResult)}}},_.payload=function(e,t){var r=t,l=u(e,r,"payload");if(l){t+=l;l=lexer_1.default.EQ(e,t);if(l){for(t=l;38!==e[t]&&t<e.length;)t++;if(t!==l)return lexer_1.default.tokenize(e,r,t,utils_1.default.stringify(e,l,t),lexer_1.default.TokenType.payload)}}},_.interval=function(e,t){var r=t,l=u(e,r,"interval");if(l){t+=l;l=lexer_1.default.EQ(e,t);if(l){for(t=l;38!==e[t]&&t<e.length;)t++;if(t!==l)return lexer_1.default.tokenize(e,r,t,utils_1.default.stringify(e,l,t),lexer_1.default.TokenType.interval)}}},_.resultFormat=function(r,l){var e=l,a=u(r,e,"resultFormat");if(a){l+=a;a=lexer_1.default.EQ(r,l);if(a){l=a;let t;return Object.keys(helpers_1.returnFormats).forEach(e=>{utils_1.default.equals(r,l,e)&&(t=e,l+=e.length)}),t?lexer_1.default.tokenize(r,e,l,{format:t},lexer_1.default.TokenType.resultFormat):void 0}}},_.id=function(e,t){var r=t;if(utils_1.default.equals(e,t,"%24id"))t+=5;else{if(!utils_1.default.equals(e,t,"$id"))return;t+=3}var l=lexer_1.default.EQ(e,t);if(l){for(t=l;38!==e[t]&&t<e.length;)t++;if(t!==l)return lexer_1.default.tokenize(e,r,t,utils_1.default.stringify(e,l,t),lexer_1.default.TokenType.Id)}},_.expand=function(t,r,l){var a=r;if(utils_1.default.equals(t,r,"%24expand"))r+=9;else{if(!utils_1.default.equals(t,r,"$expand"))return;r+=7}var u=lexer_1.default.EQ(t,r);if(u){var i=[];let e=_.expandItem(t,r=u,l);if(e){for(r=e.next;e;){i.push(e);var n=lexer_1.default.COMMA(t,r);if(!n)break;if(r=n,!(e=_.expandItem(t,r,l)))return;r=e.next}return lexer_1.default.tokenize(t,a,r,{items:i},lexer_1.default.TokenType.Expand)}}},_.expandItem=function(t,r,l){var e=r,a=lexer_1.default.STAR(t,r);if(a){r=a;const x=expressions_1.default.refExpr(t,r);if(x)return r=x.next,lexer_1.default.tokenize(t,e,r,{path:"*",ref:x},lexer_1.default.TokenType.ExpandItem);a=lexer_1.default.OPEN(t,r);if(a){a=_.levels(t,r=a);if(!a)return;r=a.next;var u=lexer_1.default.CLOSE(t,r);return u?(r=u,lexer_1.default.tokenize(t,e,r,{path:"*",levels:a},lexer_1.default.TokenType.ExpandItem)):void 0}}if(u=_.expandPath(t,r,l)){r=u.next;a={path:u};const x=expressions_1.default.refExpr(t,r);if(x){r=x.next,a.ref=x;l=lexer_1.default.OPEN(t,r);if(l){let e=_.expandRefOption(t,r=l);if(!e)return;for(var i=[];e;){i.push(e),r=e.next;var n=lexer_1.default.SEMI(t,r);if(!n)break;if(r=n,!(e=_.expandRefOption(t,r)))return}u=lexer_1.default.CLOSE(t,r);if(!u)return;r=u,a.options=i}}else{l=expressions_1.default.countExpr(t,r);if(l){r=l.next,a.count=l;u=lexer_1.default.OPEN(t,r);if(u){let e=_.expandCountOption(t,r=u);if(!e)return;for(var f=[];e;){f.push(e),r=e.next;var d=lexer_1.default.SEMI(t,r);if(!d)break;if(r=d,!(e=_.expandCountOption(t,r)))return}l=lexer_1.default.CLOSE(t,r);if(!l)return;r=l,a.options=f}}else{u=lexer_1.default.OPEN(t,r);if(u){let e=_.expandOption(t,r=u);if(!e)return;for(var o=[];e;){o.push(e),r=e.next;var s=lexer_1.default.SEMI(t,r);if(!s)break;if(r=s,!(e=_.expandOption(t,r)))return}l=lexer_1.default.CLOSE(t,r);if(!l)return;r=l,a.options=o}}}return lexer_1.default.tokenize(t,e,r,a,lexer_1.default.TokenType.ExpandItem)}},_.expandCountOption=function(e,t){return _.filter(e,t)||_.search(e,t)},_.expandRefOption=function(e,t){return _.expandCountOption(e,t)||_.orderby(e,t)||_.skip(e,t)||_.top(e,t)||_.InlineCount(e,t)},_.expandOption=function(e,t){return _.expandRefOption(e,t)||_.select(e,t)||_.expand(e,t)||_.levels(e,t)},_.expandPath=function(e,t,r){var l=t,a=[],u=nameOrIdentifier_1.default.qualifiedEntityTypeName(e,t,r)||nameOrIdentifier_1.default.qualifiedComplexTypeName(e,t,r);if(u){if(t=u.next,a.push(u),47!==e[t])return;t++,r=u.value.metadata,delete u.value.metadata}let i=nameOrIdentifier_1.default.complexProperty(e,t,r)||nameOrIdentifier_1.default.complexColProperty(e,t,r);for(;i&&47===e[i.next];){t=i.next+1,a.push(i);var n=nameOrIdentifier_1.default.qualifiedComplexTypeName(e,t,r);n&&(47===e[n.next]&&(t=n.next+1,a.push(n)),r=n.value.metadata,delete n.value.metadata),i=nameOrIdentifier_1.default.complexProperty(e,t,r)||nameOrIdentifier_1.default.complexColProperty(e,t,r)}if(u=nameOrIdentifier_1.default.navigationProperty(e,t,r))return t=u.next,a.push(u),r=u.metadata,delete u.metadata,47===e[t]&&(u=nameOrIdentifier_1.default.qualifiedEntityTypeName(e,t+1,r))&&(t=u.next,a.push(u),r=u.value.metadata,delete u.value.metadata),lexer_1.default.tokenize(e,l,t,a,lexer_1.default.TokenType.ExpandPath)},_.search=function(e,t){var r=t;if(utils_1.default.equals(e,t,"%24search"))t+=9;else{if(!utils_1.default.equals(e,t,"$search"))return;t+=7}var l=lexer_1.default.EQ(e,t);if(l){l=_.searchExpr(e,t=l);if(l)return t=l.next,lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.Search)}},_.searchExpr=function(e,t){var r,l=_.searchParenExpr(e,t)||_.searchTerm(e,t);if(l)return t=l.next,(t=_.searchAndExpr(e,t)||_.searchOrExpr(e,t))&&(r=lexer_1.default.clone(l),l.next=t.value.next,l.value={left:r,right:t.value},l.type=t.type,l.raw=utils_1.default.stringify(e,l.position,l.next),l.type===lexer_1.default.TokenType.SearchAndExpression)&&l.value.right.type===lexer_1.default.TokenType.SearchOrExpression&&(l.value.left=lexer_1.default.tokenize(e,l.value.left.position,l.value.right.value.left.next,{left:l.value.left,right:l.value.right.value.left},l.type),l.type=l.value.right.type,l.value.right=l.value.right.value.right),l},_.searchTerm=function(e,t){return _.searchNotExpr(e,t)||_.searchPhrase(e,t)||_.searchWord(e,t)},_.searchNotExpr=function(e,t){var r=lexer_1.default.RWS(e,t);if(r&&utils_1.default.equals(e,r,"NOT")){var l=t;if(t=r+3,(r=lexer_1.default.RWS(e,t))&&r!==t){r=_.searchPhrase(e,t=r)||_.searchWord(e,t);if(r)return t=r.next,lexer_1.default.tokenize(e,l,t,r,lexer_1.default.TokenType.SearchNotExpression)}}},_.searchOrExpr=function(e,t){var r=lexer_1.default.RWS(e,t);if(r&&r!==t&&utils_1.default.equals(e,r,"OR")){var l=t;if(t=r+2,(r=lexer_1.default.RWS(e,t))&&r!==t){r=_.searchExpr(e,t=r);if(r)return t=r.next,lexer_1.default.tokenize(e,l,t,r,lexer_1.default.TokenType.SearchOrExpression)}}},_.searchAndExpr=function(e,t){var r=lexer_1.default.RWS(e,t);if(r&&r!==t&&utils_1.default.equals(e,r,"AND")){var l=t;if(t=r+3,(r=lexer_1.default.RWS(e,t))&&r!==t){r=_.searchExpr(e,t=r);if(r)return t=r.next,lexer_1.default.tokenize(e,l,t,r,lexer_1.default.TokenType.SearchAndExpression)}}},_.searchPhrase=function(t,r){if((u=lexer_1.default.quotationMark(t,r))&&u!==r){var l=r,a=r=u;let e=lexer_1.default.qcharNoAMPDQUOTE(t,r);for(;e&&e>r&&!lexer_1.default.OPEN(t,r)&&!lexer_1.default.CLOSE(t,r);)r=e,e=lexer_1.default.qcharNoAMPDQUOTE(t,r);var u,i=r;if(u=lexer_1.default.quotationMark(t,r))return r=u,lexer_1.default.tokenize(t,l,r,utils_1.default.stringify(t,a,i),lexer_1.default.TokenType.SearchPhrase)}},_.searchWord=function(e,t){var r,l=utils_1.default.required(e,t,lexer_1.default.ALPHA,1);if(l)return r=t,t=l,(l=lexer_1.default.tokenize(e,r,t,null,lexer_1.default.TokenType.SearchWord)).value=l.raw,l},_.searchParenExpr=function(e,t){if(l=lexer_1.default.OPEN(e,t)){var r=t,l=(t=l,lexer_1.default.BWS(e,t));if(l){var a=_.searchExpr(e,t=l);if(a&&(t=a.next,l=lexer_1.default.BWS(e,t))){t=l;l=lexer_1.default.CLOSE(e,t);if(l)return t=l,lexer_1.default.tokenize(e,r,t,a,lexer_1.default.TokenType.SearchParenExpression)}}}},_.levels=function(t,r){var l=r;if(utils_1.default.equals(t,r,"%24levels"))r+=9;else{if(!utils_1.default.equals(t,r,"$levels"))return;r+=7}var a=lexer_1.default.EQ(t,r);if(a){r=a;let e;if(utils_1.default.equals(t,r,"max"))e="max",r+=3;else{a=primitiveLiteral_1.default.int32Value(t,r);if(!a)return;e=a.raw,r=a.next}return lexer_1.default.tokenize(t,l,r,e,lexer_1.default.TokenType.Levels)}},_.filter=function(e,t){var r=t;if(utils_1.default.equals(e,t,"%24filter"))t+=9;else{if(!utils_1.default.equals(e,t,"$filter"))return;t+=7}var l=lexer_1.default.EQ(e,t);if(l){t=l;l=expressions_1.default.boolCommonExpr(e,t);if(l)return t=l.next,lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.Filter)}},_.orderby=function(t,r){var l=r;if(utils_1.default.equals(t,r,"%24orderby"))r+=10;else{if(!utils_1.default.equals(t,r,"$orderby"))return;r+=8}var a=lexer_1.default.EQ(t,r);if(a){var u=[];let e=_.orderbyItem(t,r=a);if(e){for(r=e.next;e;){u.push(e);var i=lexer_1.default.COMMA(t,r);if(!i)break;if(r=i,!(e=_.orderbyItem(t,r)))return;r=e.next}return lexer_1.default.tokenize(t,l,r,{items:u},lexer_1.default.TokenType.OrderBy)}}},_.orderbyItem=function(t,r){var l=expressions_1.default.commonExpr(t,r);if(l){var a=r;r=l.next;let e=1;var u=lexer_1.default.RWS(t,r);if(u&&r<u)if(r=u,utils_1.default.equals(t,r,"asc"))r+=3;else{if(!utils_1.default.equals(t,r,"desc"))return;r+=4,e=-1}return lexer_1.default.tokenize(t,a,r,{expr:l,direction:e},lexer_1.default.TokenType.OrderByItem)}},_.skip=function(e,t){var r=t;if(utils_1.default.equals(e,t,"%24skip"))t+=7;else{if(!utils_1.default.equals(e,t,"$skip"))return;t+=5}var l=lexer_1.default.EQ(e,t);if(l){t=l;l=primitiveLiteral_1.default.int32Value(e,t);if(l)return t=l.next,lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.Skip)}},_.top=function(e,t){var r=t;if(utils_1.default.equals(e,t,"%24top"))t+=6;else{if(!utils_1.default.equals(e,t,"$top"))return;t+=4}var l=lexer_1.default.EQ(e,t);if(l){t=l;l=primitiveLiteral_1.default.int32Value(e,t);if(l)return t=l.next,lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.Top)}},_.log=function(e,t){var r=t;if(utils_1.default.equals(e,t,"%24log"))t+=6;else{if(!utils_1.default.equals(e,t,"$log"))return;t+=4}var l=lexer_1.default.EQ(e,t);if(l){t=l;l=primitiveLiteral_1.default.int32Value(e,t);if(l)return t=l.next,lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.Log)}},_.format=function(t,r){var l=r;if(utils_1.default.equals(t,r,"%24format"))r+=9;else{if(!utils_1.default.equals(t,r,"$format"))return;r+=7}var a=lexer_1.default.EQ(t,r);if(a){r=a;let e;return utils_1.default.equals(t,r,"atom")?(e="atom",r+=4):utils_1.default.equals(t,r,"json")?(e="json",r+=4):utils_1.default.equals(t,r,"xml")&&(e="xml",r+=3),e?lexer_1.default.tokenize(t,l,r,{format:e},lexer_1.default.TokenType.Format):void 0}},_.InlineCount=function(e,t){var r=t;if(utils_1.default.equals(e,t,"%24count"))t+=8;else{if(!utils_1.default.equals(e,t,"$count"))return;t+=6}var l=lexer_1.default.EQ(e,t);if(l){t=l;l=primitiveLiteral_1.default.booleanValue(e,t);if(l)return t=l.next,lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.InlineCount)}},_.select=function(t,r){var l=r;if(utils_1.default.equals(t,r,"%24select"))r+=9;else{if(!utils_1.default.equals(t,r,"$select"))return;r+=7}var a=lexer_1.default.EQ(t,r);if(a){var u=[];let e=_.selectItem(t,r=a);if(e){for(;e;){u.push(e),r=e.next;var i=lexer_1.default.COMMA(t,r);if(!i)break;if(r=i,!(e=_.selectItem(t,r)))return}return lexer_1.default.tokenize(t,l,r,{items:u},lexer_1.default.TokenType.Select)}}},_.selectItem=function(e,t){var r=t;let l;var a=_.allOperationsInSchema(e,t),u=lexer_1.default.STAR(e,t);if(t<a)l={namespace:utils_1.default.stringify(e,t,a-2),value:"*"},t=a;else if(u)l={value:"*"},t=u;else{l={};a=nameOrIdentifier_1.default.qualifiedEntityTypeName(e,t)||nameOrIdentifier_1.default.qualifiedComplexTypeName(e,t);if(a&&47!==e[a.next])return;a&&47===e[a.next]&&(t++,l.name=a);u=_.selectProperty(e,t)||_.qualifiedActionName(e,t)||_.qualifiedFunctionName(e,t);if(!u)return;t=u.next,l=a?{name:a,select:u}:u}if(r<t)return lexer_1.default.tokenize(e,r,t,l,lexer_1.default.TokenType.SelectItem)},_.allOperationsInSchema=function(e,t){var r=nameOrIdentifier_1.default.namespace(e,t),l=lexer_1.default.STAR(e,r+1);return t<r&&46===e[r]&&l?l:t},_.selectProperty=function(e,t){var r=_.selectPath(e,t)||nameOrIdentifier_1.default.primitiveProperty(e,t)||nameOrIdentifier_1.default.primitiveColProperty(e,t)||nameOrIdentifier_1.default.navigationProperty(e,t);if(r){var l=t;if(t=r.next,r.type===lexer_1.default.TokenType.SelectPath&&47===e[t]){t=_.selectProperty(e,++t);if(!t)return;var a=lexer_1.default.clone(r);r.next=t.next,r.raw=utils_1.default.stringify(e,l,r.next),r.value={path:a,next:t}}return r}},_.selectPath=function(t,r){var l=nameOrIdentifier_1.default.complexProperty(t,r)||nameOrIdentifier_1.default.complexColProperty(t,r);if(l){var a,u=r;let e=l;return 47===t[r=l.next]&&(a=nameOrIdentifier_1.default.qualifiedComplexTypeName(t,r+1))&&(r=a.next,e={prop:l,name:a}),lexer_1.default.tokenize(t,u,r,e,lexer_1.default.TokenType.SelectPath)}},_.qualifiedActionName=function(e,t){var r=nameOrIdentifier_1.default.namespace(e,t);if(r!==t&&46===e[r]){var l=t,t=(t=r+1,nameOrIdentifier_1.default.action(e,t));if(t)return t.value.namespace=utils_1.default.stringify(e,l,r),lexer_1.default.tokenize(e,l,t.next,t,lexer_1.default.TokenType.Action)}},_.qualifiedFunctionName=function(e,t){var r=nameOrIdentifier_1.default.namespace(e,t);if(r!==t&&46===e[r]){var l=t,a=(t=r+1,nameOrIdentifier_1.default.odataFunction(e,t));if(a){a.value.namespace=utils_1.default.stringify(e,l,r),t=a.next;var u={name:a},r=lexer_1.default.OPEN(e,t);if(r){t=r,u.parameters=[];var i=expressions_1.default.parameterName(e,t);if(!i)return;for(;i;){t=i.next,u.parameters.push(i);var n=lexer_1.default.COMMA(e,t);if(!n)break;if(t=n,!expressions_1.default.parameterName(e,t))return}a=lexer_1.default.CLOSE(e,t);if(!a)return;t=a}return lexer_1.default.tokenize(e,l,t,u,lexer_1.default.TokenType.Function)}}},_.skiptoken=function(t,r){var l=r;if(utils_1.default.equals(t,r,"%24skiptoken"))r+=12;else{if(!utils_1.default.equals(t,r,"$skiptoken"))return;r+=10}var a=lexer_1.default.EQ(t,r);if(a){r=a;let e=lexer_1.default.qcharNoAMP(t,r);if(e){for(a=r;e&&e>r;)r=e,e=lexer_1.default.qcharNoAMP(t,r);return lexer_1.default.tokenize(t,l,r,utils_1.default.stringify(t,a,r),lexer_1.default.TokenType.SkipToken)}}},_.aliasAndValue=function(e,t){var r=expressions_1.default.parameterAlias(e,t);if(r){var l=t,a=(t=r.next,lexer_1.default.EQ(e,t));if(a){t=a;a=expressions_1.default.parameterValue(e,t);if(a)return t=a.next,lexer_1.default.tokenize(e,l,t,{alias:r,value:a},lexer_1.default.TokenType.AliasAndValue)}}}}(Query=Query||{}),exports.default=Query;