"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RootPgVisitor=void 0;const helpers_1=require("../../../helpers"),logger_1=require("../../../logger"),helper_1=require("../helper"),enums_1=require("../../../enums"),models_1=require("../../../models"),log_1=require("../../../log"),constants_1=require("../../../constants"),_1=require("../.");class RootPgVisitor extends _1.PgVisitor{static root=!0;constructor(e,t={},i){super(e,t),i&&this.StartVisitRessources(i)}verifyRessources=()=>{};VisitRessources(e,t){var i=this["VisitRessources"+e.type];if(i)return i.call(this,e,t),this.debugOdata,this;throw log_1.log.errorMsg("Ressource Not Found ============> VisitRessources"+e.type),new Error("Unhandled node type: "+e.type)}VisitRessourcesResourcePath(e,t){e.value.resource&&"EntitySetName"==e.value.resource.type&&(this.entity=e.value.resource.raw),e.value.navigation&&this.VisitRessources(e.value.navigation,t)}VisitRessourcesEntitySetName(e,t){this.entity=e.value.raw}VisitRessourcesRefExpression(e,t){"RefExpression"==e.type&&"/$ref"==e.raw&&(this.onlyRef=!0)}VisitRessourcesValueExpression(e,t){"ValueExpression"==e.type&&"/$value"==e.raw&&(this.onlyValue=!0)}VisitRessourcesCollectionNavigation(e,t){e.value.path&&this.VisitRessources(e.value.path,t)}VisitRessourcesCollectionNavigationPath(e,t){e.value.predicate&&this.VisitRessources(e.value.predicate,t),e.value.navigation&&this.VisitRessources(e.value.navigation,t)}VisitRessourcesSimpleKey(e,t){"KeyPropertyValue"===e.value.value.type&&this.VisitRessources(e.value.value,t)}VisitRessourcesKeyPropertyValue(e,t){this.id=this.ctx.decodedUrl.idStr||("Edm.SByte"==e.value?BigInt(e.raw):e.raw),this.query.where.init(this.ctx.decodedUrl.idStr?`"lora"."deveui" = '${this.ctx.decodedUrl.idStr}'`:"id = "+this.id)}VisitRessourcesSingleNavigation(e,t){e.value.path&&"PropertyPath"===e.value.path.type&&this.VisitRessources(e.value.path,t)}VisitRessourcesPropertyPath(e,t){var i,s;"PropertyPath"==e.type&&(models_1.models.getRelationColumnTable(this.ctx.config,this.entity,e.value.path.raw)===enums_1.EnumColumnType.Relation?(this.parentId=this.id,this.id=BigInt(0),e.value.navigation&&"CollectionNavigation"==e.value.navigation.type&&"CollectionNavigationPath"===(i=e.value.navigation).value.path.type&&"SimpleKey"===(i=i.value.path).value.predicate.type&&"KeyPropertyValue"===(i=i.value.predicate.value).value.type&&(this.id=i.value.raw),s=(i=this.ctx.model[this.entity].relations[e.value.path.raw].link.split("$ID").join(this.parentId)).split("in ("),0<BigInt(this.id)?this.query.where.init(`${s[0]} = (SELECT id FROM (${s[1]} as l WHERE id = ${this.id})`):this.query.where.init(i),this.parentEntity=this.entity,this.entity=e.value.path.raw):this.ctx.model[this.entity].columns[e.value.path.raw]?(this.query.select.add(""+(0,helpers_1.addDoubleQuotes)(e.value.path.raw)+constants_1._COLUMNSEPARATOR),this.showRelations=!1):this.entity=e.value.path.raw)}VisitRessourcesODataUri(e,t){this.VisitRessources(e.value.resource,t),this.VisitRessources(e.value.query,t)}StartVisitRessources(e){this.limit=this.ctx.config.nb_page||200,this.numeric=this.ctx.config.extensions.includes(enums_1.EnumExtensions.numeric);e=this.VisitRessources(e);return this.verifyRessources(),e}getSql(){return this.includes&&this.includes.forEach(e=>{var t,i;e.navigationProperty.includes("/")&&(t=e.navigationProperty.split("/"),e.navigationProperty=t[0],i=new _1.PgVisitor(this.ctx,{...this.options}))&&(i.entity=t[0],i.navigationProperty=t[1],e.includes?e.includes.push(i):e.includes=[i])}),this.onlyValue?this.toString():this.returnFormat.generateSql(this)}patchSql(e){try{return(0,helper_1.postSqlFromPgVisitor)(e,this)}catch(e){}}postSql(e){try{return(0,helper_1.postSqlFromPgVisitor)(e,this)}catch(e){}}}exports.RootPgVisitor=RootPgVisitor;