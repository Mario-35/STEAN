"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Query=void 0;const constants_1=require("../../../constants"),logger_1=require("../../../logger"),helpers_1=require("../../../helpers"),queries_1=require("../../../db/queries"),models_1=require("../../../models"),enums_1=require("../../../enums"),_1=require("."),messages_1=require("../../../messages");class Query{where;select;orderBy;groupBy;keyNames;_pgQuery=void 0;constructor(){this.where=new _1.Where,this.select=new _1.Select,this.orderBy=new _1.OrderBy,this.groupBy=new _1.GroupBy,this.keyNames=new _1.Key([])}columnList(e,s,i){const l=t=>0<["CONCAT","CASE","COALESCE"].map(e=>!!t.includes(e)).filter(e=>!0===e).length;const r=models_1.models.getEntity(s.ctx.config,e);if(r){if((0,helpers_1.isGraph)(s))return[s.interval?`timestamp_ceil("resultTime", interval '${s.interval}') AS srcdate`:"@GRAPH@"];const o=(0,helpers_1.isCsvOrArray)(s)&&!i.query.select.toString().includes('"id"'+constants_1._COLUMNSEPARATOR)?["id"]:[],n=`CONCAT('${s.ctx.decodedUrl.root}/${r.name}(', "${r.table}"."id", ')') AS "@iot.selfLink"`;return 1==i.onlyRef?[n]:(1==i.showRelations&&o.push(n),("*"===i.query.select.toString()||""===i.query.select.toString()?Object.keys(r.columns).filter(e=>!e.includes("_")).filter(e=>!("result"===e&&i.splitResult)).filter(e=>!r.columns[e].extensions||r.columns[e].extensions&&s.ctx.config.extensions.includes(r.columns[e].extensions||"")):i.query.select.toString().split(constants_1._COLUMNSEPARATOR).filter(e=>""!=e.trim()).map(e=>(0,helpers_1.removeDoubleQuotes)(e))).map(e=>{var t=!!["id","result"].includes(e);return function(t,r,s,i){if(r.columns[s]){t=r.columns[s].alias(t,i||void 0);if(!0===l(t||s))return t||s;if(i){if(t&&!0===i.alias)return t;let e="";return!0===i.table&&!1===l(t||s)&&(e+=(0,helpers_1.addDoubleQuotes)(r.table)+"."),e+=t||!0===i.quoted?(0,helpers_1.addDoubleQuotes)(s):s,(!0===i.as||t&&t.includes("->"))&&(e+=" AS "+(0,helpers_1.addDoubleQuotes)(s)),e}return s}if(!0===l(s))return s}(s.ctx.config,r,e,{valueskeys:i.valueskeys,quoted:!0,table:!0,alias:t,as:!(0,helpers_1.isGraph)(s)})||""}).filter(e=>""!=e).forEach(e=>{var t,r=(0,helpers_1.isCsvOrArray)(i);r&&this.keyNames.add(e),o.push(e),s.interval&&s.addToIntervalColumns(((t=(t=e).split(t.includes(" AS ")?" AS ":".")).shift(),t.join("."))),"id"!==e||1!=i.showRelations&&!(0,helpers_1.isCsvOrArray)(s)||(r?this.keyNames.add("id"):o.push(n)),r&&["payload","deveui","phenomenonTime"].includes((0,helpers_1.removeAllQuotes)(e))&&this.keyNames.add(e)}),s.interval&&s.addToIntervalColumns(`CONCAT('${s.ctx.decodedUrl.root}/${r.name}(', COALESCE("@iot.id", '0')::text, ')') AS "@iot.selfLink"`),!0===(0,helpers_1.isObservation)(r)&&!1===i.onlyRef&&(s.interval&&!(0,helpers_1.isGraph)(s)&&o.push(`timestamp_ceil("resultTime", interval '${s.interval}') AS srcdate`),i.splitResult)&&i.splitResult.forEach(e=>{var t=i&&i.splitResult&&1===i.splitResult.length,r=t?"result":e;o.push(`(result->>'valueskeys')::json->'${i.splitResult&&t?(0,helpers_1.removeAllQuotes)(i.splitResult[0]):r}' AS "${t?e:r}"`),this.keyNames.add(t?e:r)}),o)}}create(s,e){const i=e||s;if(""!==i.entity.trim()){const l=this.columnList(i.entity,s,i);if(l){const o=models_1.models.getEntityName(s.ctx.config,i.entity);if(o){const n=Object.keys(s.ctx.model[o].relations);return i.includes&&i.includes.forEach(e=>{var t=e.navigationProperty,r=n.indexOf(t);if(0<=r){e.entity=t,e.query.where.add((!0===e.query.where.notNull()?" AND ":"")+s.ctx.model[o].relations[t].expand);e=this.pgQueryToString(this.create(e));if(!e)throw new Error(messages_1.errors.invalidQuery);n[r]=`(${(0,queries_1.asJson)({query:e,singular:models_1.models.isSingular(s.ctx.config,t),strip:s.ctx.config.stripNull,count:!1})}) AS `+(0,helpers_1.addDoubleQuotes)(t)}}),n.filter(e=>e.includes("SELECT")||Object.keys(s.ctx.model).includes(models_1.models.getEntityName(s.ctx.config,e)||e)).forEach(t=>{if("("==t[0])l.push(t);else if(1==i.showRelations&&0==s.onlyRef){var r=models_1.models.getEntityName(s.ctx.config,t);let e=void 0;r&&!s.ctx.model[o].relations[t].relationKey.startsWith("_")&&!0===s.ctx.config.stripNull&&o===s.ctx.model[enums_1.allEntities.Observations].name&&r.endsWith(s.ctx.model[enums_1.allEntities.Datastreams].name)&&(e=`CASE WHEN ${s.ctx.model[r].table}_id NOTNULL THEN`),l.push(`${e||""} CONCAT('${s.ctx.decodedUrl.root}/${s.ctx.model[o].name}(', ${(0,helpers_1.addDoubleQuotes)(s.ctx.model[o].table)}."id", ')/${t}') ${e?"END ":""}AS "${t}@iot.navigationLink"`),s.addToIntervalColumns(`'${s.ctx.decodedUrl.root}/${s.ctx.model[o].name}(0)/${t}' AS "${t}@iot.navigationLink"`)}}),{select:l.join(",\n\t\t"),from:s.ctx.model[o].table,where:i.query.where.toString(),groupBy:!0===i.query.groupBy.notNull()?i.query.groupBy.toString():void 0,orderBy:!0===i.query.orderBy.notNull()?i.query.orderBy.toString():s.ctx.model[o].orderBy,skip:i.skip,limit:i.limit,keys:this.keyNames.toArray(),count:`SELECT COUNT (DISTINCT ${Object.keys(s.ctx.model[o].columns)[0]}) FROM (SELECT ${Object.keys(s.ctx.model[o].columns)[0]} FROM "${s.ctx.model[o].table}"${!0===i.query.where.notNull()?" WHERE "+i.query.where.toString():""}) AS c`}}}}}pgQueryToString(e){return e?`SELECT ${e.select}
 FROM "${e.from}"
 ${e.where?`WHERE ${e.where}
`:""}${e.groupBy?`GROUP BY ${(0,helpers_1.cleanStringComma)(e.groupBy)}
`:""}${e.orderBy?`ORDER BY ${(0,helpers_1.cleanStringComma)(e.orderBy,["ASC","DESC"])}
`:""}${e.skip&&0<e.skip?`OFFSET ${e.skip}
`:""} `+(e.limit&&0<e.limit?`LIMIT ${e.limit}
`:""):void 0}toString(e,t){this._pgQuery||(this._pgQuery=this.create(e,t));e=this.pgQueryToString(this._pgQuery);if(e)return e;throw new Error(messages_1.errors.invalidQuery)}toPgQuery(e,t){return this._pgQuery||(this._pgQuery=this.create(e,t)),this._pgQuery}}exports.Query=Query;