class QueryBuilder{constructor(e,t){if(this.conditions={general:{eq:"Equal to",ne:"Not equal to",nu:"null",nn:"Notnull"},number:{gt:"Greater than",lt:"Lesser than",between:"Between"},result:{gt:"Greater than",lt:"Lesser than",between:"Between"},date:{gt:"Greater than",lt:"Lesser than",between:"Between"},text:{contains:"Includes",notincludes:"Does not include",startswith:"Starts with",endswith:"Ends with",regex:"Regular expression"},closed:{isoneof:"Is one of",isall:"Is all",notall:"Is not all",notoneof:"Is not one of"}},this.inputTypes={singleinput:["eq","ne","contains","notincludes","startswith","endswith","gt","lt","regex"],doubleinput:["between"],select:["isoneof","isall","notall","notoneof"]},this.fields=t,"string"!=typeof e&&!(e instanceof HTMLElement))throw TypeError("Element must be a string or element");if("string"==typeof e){if(this.element=getElement(e),null===this.element)throw Error(`Element with id ${e} could not be found`)}else this.element=e;this.choiceElements=[],this.queryContainer=null,this.criteriumButton=null,this.lastCriteria={},this._query=[],this.setupQueryContainer()}clear(e,t){var n=document.querySelectorAll(".remove-criterium-button");this.fields=t,n.forEach(e=>e.click())}get query(){return this._query}set query(e){this._query=e,this.buildFromQuery(e)}buildResult(e){e=e.querySelectorAll(".criterium-container");const t=[];e.forEach(e=>{const r=[];e.querySelectorAll(".criterium").forEach(e=>{var t=e.querySelector(".criteria-select").value,n=null==(n=e.querySelector(".condition-select"))?void 0:n.value,e=e.querySelector(".valueinput");let i=null;null!==e.querySelector(".value-singleinput")?i=e.querySelector(".value-singleinput").innerHTML:null!==e.querySelector(".value-doubleinput")&&(i={first:e.querySelector(".doubleinput-firstvalue").value,second:e.querySelector(".doubleinput-secondvalue").value}),e={criterium:t,condition:n,value:i},r.push(e)}),t.push(r)}),this._query=t,this.element.innerText=JSON.stringify(this.query)}setupQueryContainer(){this.element.hidden=!0;var e=document.createElement("div"),t=(e.classList.add("query-container"),e.id="query-container",this.queryContainer=this.element.parentNode.insertBefore(e,this.element),document.createElement("button"));t.classList.add("criterium-button"),t.innerText="+",t.addEventListener("click",e=>{e.preventDefault(),this.addNewCriterium(this.addNewCriteriumContainer())}),this.criteriumButton=e.appendChild(t),this.queryContainer.addEventListener("focusout",()=>{this.buildResult(this.queryContainer),this.element.innerText=JSON.stringify(this.query)}),""!==this.element.innerText&&void 0!==this.element.innerText&&this.buildFromQuery(JSON.parse(this.element.innerText)),this.buildResult(this.queryContainer)}addNewCriteriumContainer(){var e,t=document.createElement("div");return t.classList.add("criterium-container"),t.id="criterium-container-"+this.makeid(10),null!==this.queryContainer.querySelector(".criterium-container")&&((e=document.createElement("p")).classList.add("criteria-link"),e.innerText="OR",this.queryContainer.insertBefore(e,this.criteriumButton)),this.queryContainer.insertBefore(t,this.criteriumButton),t}addNewCriterium(t,e=null){const n=document.createElement("div"),i=(n.classList.add("criterium"),n.id="criterium-"+this.makeid(10),[]);this.fields.forEach(e=>{i.push(void 0===e.label||null===e.label?e.value:e.label)});var r=document.createElement("div");r.classList.add("criteria-choice-container"),n.appendChild(r);const l=document.createElement("select");l.classList.add("criteria-select","patrom-select"),r.appendChild(l),l.addEventListener("change",e=>{this.addConditionSelector(n,l.value)}),i.forEach(e=>{e=new Option(e,e);l.add(e)}),null===t.querySelector(".add-condition-button")?(t.appendChild(n),(r=document.createElement("button")).classList.add("add-condition-button","patrom-button"),r.innerText="+ add 'AND' condition",r.addEventListener("click",e=>{e.preventDefault(),this.addNewCriterium(t)}),t.appendChild(r)):(t.insertBefore(n,t.querySelector(".add-condition-button")),(r=document.createElement("p")).classList.add("conditions-link"),r.innerHTML="AND",t.insertBefore(r,n)),null===e&&this.addConditionSelector(n,l.value),this.addRemoveCriteriumButton(n),this.buildResult(this.queryContainer)}addConditionSelector(t,n,e=null){var i=t.querySelector(".condition-container"),i=(null!==i&&i.remove(),document.createElement("div"));i.classList.add("condition-container"),i.id="condition-container-"+this.makeid(10);const r=document.createElement("select");r.classList.add("condition-select","patrom-select"),i.appendChild(r);var l=this.fields.find(e=>e.value===n).type;let a=Object.assign({},this.conditions[l]);"closed"!==l&&(a=Object.assign(a,this.conditions.general)),Object.entries(a).forEach(([t,e])=>{e=new Option(e,t);Array.from(r.options).find(e=>e.value===t)||r.add(e)}),null!==t.querySelector(".valueinput")?t.insertBefore(i,t.querySelector(".valueinput")):t.appendChild(i),r.addEventListener("change",e=>{this.addValueInput(t)}),e?(this.addValueInput(t,e.value),r.value=e.condition):this.addValueInput(t)}addValueInput(e,t=null){var n=e.querySelector(".condition-select"),i=(null!==e.querySelector(".valueinput")&&e.querySelector(".valueinput").remove(),document.createElement("div"));if(i.classList.add("valueinput"),e.insertBefore(i,e.querySelector(".remove-criterium-button")),this.inputTypes.singleinput.includes(n.value)){var r=document.createElement("span");r.role="text",r.contentEditable="true",r.classList.add("value-singleinput","patrom-text-input"),r.classList.add("textarea"),i.appendChild(r),r.focus(),null!==t&&(r.textContent=t)}else if(this.inputTypes.doubleinput.includes(n.value)){var r=document.createElement("div"),l=(r.classList.add("value-doubleinput"),document.createElement("input")),a=(l.type="text",l.classList.add("doubleinput-firstvalue","patrom-text-input"),r.appendChild(l),null!==t&&(l.value=t.first),document.createElement("p")),a=(a.innerHTML="and",r.appendChild(a),document.createElement("input"));a.type="text",a.classList.add("doubleinput-secondvalue","patrom-text-input"),r.appendChild(a),null!==t&&(a.value=t.second),i.appendChild(r),l.focus()}else if(this.inputTypes.select.includes(n.value)){a=document.createElement("select");a.multiple=!0,a.classList.add("value-select","patrom-select"),i.appendChild(a);const u=e.querySelector(".criteria-select").value;r=this.fields.find(e=>e.value===u);void 0!==r&&r.values.map(e=>"string"==typeof t?{label:this.capitalizeFirstLetter(e),value:e}:{label:e.label,value:e.value})}}addRemoveCriteriumButton(t){var e=document.createElement("button");e.classList.add("remove-criterium-button","patrom-button","patrom-button--danger"),e.innerHTML="âœ•",t.appendChild(e),e.addEventListener("click",e=>{e.preventDefault();e=t.previousElementSibling,null!==e&&e.classList.contains("criteria-link")&&e.remove(),e=t.parentElement.children;(2===e.length?(null!==t.parentElement.previousElementSibling?t.parentElement.previousElementSibling.remove():t.parentElement.nextElementSibling.classList.contains("criteria-link")&&t.parentElement.nextElementSibling.remove(),t.parentElement):((null!==t.previousSibling?t.previousSibling:t.nextSibling).remove(),t)).remove(),this.buildResult(this.queryContainer)})}buildFromQuery(e){e.forEach(e=>{const t=this.addNewCriteriumContainer();e.forEach(e=>{this.addNewCriterium(t,e)})})}capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}formatName(e){return this.capitalizeFirstLetter(e).replace("_"," ")}makeid(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=n.length,r=0;r<e;r++)t+=n.charAt(Math.floor(Math.random()*i));return t}}function updateBuilder(){const t=getEntityName(SubOrNot());if(t){var e=getColumnsList(t);const n=[];e.forEach(e=>{n.push({value:e,label:e,type:_PARAMS._DATAS[t].columns[e]&&_PARAMS._DATAS[t].columns[e].type?_PARAMS._DATAS[t].columns[e].type:"text"})}),builder?builder.clear("query-builder",n):builder=new QueryBuilder("query-builder",n)}}