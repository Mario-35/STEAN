"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createTable=void 0;const configuration_1=require("../../configuration"),constants_1=require("../../constants"),log_1=require("../../log"),helpers_1=require("../../helpers"),logger_1=require("../../logger"),createTable=async(e,t,n)=>{if(!t)return{};var o=()=>" ".repeat(5);const r=[],a=[];var s,c={};if(!configuration_1.serverConfig.connection(e))return log_1.log.errorMsg("connection Error"),{error:"connection Error"};Object.keys(t.columns).forEach(e=>{""!=t.columns[e].create.trim()&&r.push((0,helpers_1.addDoubleQuotes)(e)+" "+t.columns[e].create)}),s=r.join(", "),t.constraints&&Object.keys(t.constraints).forEach(e=>{t.constraints&&a.push(`ALTER TABLE ONLY ${(0,helpers_1.addDoubleQuotes)(t.table)} ADD CONSTRAINT ${(0,helpers_1.addDoubleQuotes)(e)} ${t.constraints[e]};`)}),""!=t.table.trim()&&(c[String("Create table "+(0,helpers_1.addDoubleQuotes)(t.table))]=await configuration_1.serverConfig.connection(e).unsafe(`CREATE TABLE ${(0,helpers_1.addDoubleQuotes)(t.table)} (${s});`).then(()=>constants_1._OK).catch(e=>e.message));const i=t.indexes,u=[];return i&&Object.keys(i).forEach(e=>{u.push(`CREATE INDEX "${e}" `+i[e])}),0<u.length&&(c[o()+"Create indexes for "+t.name]=await configuration_1.serverConfig.connection(e).unsafe(u.join(";")).then(()=>constants_1._OK).catch(e=>e.message)),t.constraints&&0<a.length&&(c[o()+"Create constraints for "+t.table]=await configuration_1.serverConfig.connection(e).unsafe(a.join(" ")).then(()=>constants_1._OK).catch(e=>e.message)),t.after&&t.after.toUpperCase().startsWith("INSERT")&&(c[o()+"Something to do after for "+t.table]=await configuration_1.serverConfig.connection(e).unsafe(t.after).then(()=>constants_1._OK).catch(e=>(log_1.log.errorMsg(e),e.message))),n&&(c[o()+" doAfter "+t.table]=await configuration_1.serverConfig.connection(e).unsafe(n).then(()=>constants_1._OK).catch(e=>e.message)),c};exports.createTable=createTable;