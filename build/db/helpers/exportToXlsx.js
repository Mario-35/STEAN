"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.exportToXlsx=void 0;const exceljs_1=__importDefault(require("exceljs")),configuration_1=require("../../configuration"),log_1=require("../../log"),helpers_1=require("../../helpers"),models_1=require("../../models"),enums_1=require("../../enums"),addConfigToExcel=async(e,o)=>{const n=e.addWorksheet("Config");n.columns=[{key:"key",header:"key"},{key:"value",header:"value"}],n.columns.forEach(e=>{e.font={size:12},e.width=30}),n.getRow(1).font={bold:!0,size:13},Object.keys(o).forEach(e=>{n.addRow({key:e,value:"object"==typeof o[e]?Array(o[e]).toString():o[e]})})},addToExcel=async(e,o,n)=>{if(n&&n[0]){const t=e.addWorksheet(o),s=[];Object.keys(n[0]).forEach(e=>{s.push({key:e,header:e})}),t.columns=s,t.columns.forEach(e=>{e.font={size:12},e.width=30}),0<Object.values(n).length&&(t.getRow(1).font={bold:!0,size:13},Object.values(n).forEach(e=>{t.addRow(e)}))}},createColumnsList=async(s,o)=>{const a=[];return await(0,helpers_1.asyncForEach)(Object.keys(s.model[o].columns),async n=>{const t=e=>`select distinct ${e} AS "${n}" from "${s.model[o].table}" LIMIT 200`;var e;""!==s.model[o].columns[n].create&&(models_1.models.isColumnType(s.config,s.model[o],n,"json")?(e=await configuration_1.serverConfig.connection(s.config.name).unsafe(t(`jsonb_object_keys("${n}")`)).catch(async e=>{var o;"22023"===e.code?(o=await configuration_1.serverConfig.connection(s.config.name).unsafe(t(`jsonb_object_keys("${n}"[0])`)).catch(async e=>{var o;"42804"===e.code?(o=await configuration_1.serverConfig.connection(s.config.name).unsafe(t(`jsonb_object_keys(jsonb_array_elements("${n}"))`)))&&0<o.length&&o.forEach(e=>{a.push(`jsonb_array_elements("${n}")->>'${e[n]}' AS "${n}-${e[n]}"`)}):log_1.log.errorMsg(e)}))&&0<o.length&&o.forEach(e=>{a.push(`"${n}"[0]->>'${e[n]}' AS "${n}-${e[n]}"`)}):log_1.log.errorMsg(e)}))&&0<e.length&&e.forEach(e=>{a.push(`"${n}"->>'${e[n]}' AS "${n}-${e[n]}"`)}):a.push(`"${n}"`))}),a},exportToXlsx=async n=>{const t=new exceljs_1.default.Workbook;t.creator="Me",t.lastModifiedBy="Her",t.created=new Date(Date.now()),t.modified=new Date(Date.now()),addConfigToExcel(t,configuration_1.serverConfig.getConfigForExcelExport(n.config.name)),await(0,helpers_1.asyncForEach)(Object.keys((0,enums_1.filterEntities)(n.config)).filter(e=>""!==n.model[e].table),async e=>{var o=await createColumnsList(n,e),o=await configuration_1.serverConfig.connection(n.config.name).unsafe(`select ${o} from "${n.model[e].table}" LIMIT 200`);await addToExcel(t,e,o)}),n.status=200,n.response.attachment(n.config.name+".xlsx"),await t.xlsx.write(n.res),n.res.end()};exports.exportToXlsx=exportToXlsx;