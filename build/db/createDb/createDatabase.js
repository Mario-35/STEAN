"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createDatabase=void 0;const helpers_1=require("../helpers"),configuration_1=require("../../configuration"),helpers_2=require("../../helpers"),logger_1=require("../../logger"),constants_1=require("../constants"),enums_1=require("../../enums"),constants_2=require("../../constants"),triggers_1=require("./triggers"),models_1=require("../../models"),log_1=require("../../log"),createDatabase=async t=>{const s=configuration_1.serverConfig.getConfig(t).pg,a={"Start create Database":s.database},r=configuration_1.serverConfig.connectionAdminFor(t);if(r){await r.unsafe("CREATE DATABASE "+s.database).then(async()=>{a["Create Database"]=s.database+" "+constants_2._OK,await r.unsafe(`SELECT COUNT(*) FROM pg_user WHERE usename = ${(0,helpers_2.addSimpleQuotes)(s.user)};`).then(async e=>{0==e[0].count?a["CREATE ROLE "+s.user]=await r.unsafe(`CREATE ROLE ${s.user} WITH PASSWORD ${(0,helpers_2.addSimpleQuotes)(s.password)} `+constants_1._RIGHTS).then(()=>constants_2._OK).catch(e=>e.message):await r.unsafe(`ALTER ROLE ${s.user} WITH PASSWORD ${(0,helpers_2.addSimpleQuotes)(s.password)}  `+constants_1._RIGHTS).then(()=>{a["Create/Alter ROLE"]=s.user+" "+constants_2._OK}).catch(e=>{log_1.log.errorMsg(e)})})}).catch(e=>{log_1.log.errorMsg(e)});var e=configuration_1.serverConfig.connection(t);if(e){a["Create postgis"]=await e.unsafe("CREATE EXTENSION IF NOT EXISTS postgis").then(()=>constants_2._OK).catch(e=>e.message),a["Create tablefunc"]=await e.unsafe("CREATE EXTENSION IF NOT EXISTS tablefunc").then(()=>constants_2._OK).catch(e=>e.message);const n=models_1.models.DBFull(t);await(0,helpers_2.asyncForEach)(Object.keys(n),async e=>{const s=await(0,helpers_1.createTable)(t,n[e],void 0);Object.keys(s).forEach(e=>log_1.log.create(e,s[e]))}),await(0,helpers_2.asyncForEach)((0,triggers_1.triggers)(t),async e=>{const s=e.split(" */")[0].split("/*")[1].trim();await configuration_1.serverConfig.connection(t).unsafe(e).then(()=>{log_1.log.create(s,constants_2._OK)}).catch(e=>{process.exit(111)})}),configuration_1.serverConfig.getConfig(t).extensions.includes(enums_1.EnumExtensions.numeric)&&(await e.unsafe(`ALTER TABLE ${(0,helpers_2.addDoubleQuotes)(n.Observations.table)} ALTER COLUMN 'result' TYPE float4 USING null;`).catch(e=>(log_1.log.errorMsg(e),e)),await e.unsafe(`ALTER TABLE ${(0,helpers_2.addDoubleQuotes)(n.HistoricalLocations.table)}  ALTER COLUMN '_result' TYPE float4 USING null;`).catch(e=>(log_1.log.errorMsg(e),e))),a["Create user"]=await(0,helpers_1.createUser)(configuration_1.serverConfig.getConfig(t)).then(()=>constants_2._OK).catch(e=>e.message),await e.unsafe(`SELECT COUNT(*) FROM pg_user WHERE usename = ${(0,helpers_2.addSimpleQuotes)(s.user)};`).then(()=>{a["ALL finished ..."]=constants_2._OK})}else a["DROP Error"]="No DB connection "+constants_2._NOTOK}else a["DROP Error"]="No Admin connection";return a};exports.createDatabase=createDatabase;