"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Common=void 0;const index_1=require("../../helpers/index"),logger_1=require("../../logger"),helpers_1=require("../helpers"),messages_1=require("../../messages"),log_1=require("../../log");class Common{ctx;nextLinkBase;linkBase;constructor(t){this.ctx=t,this.nextLinkBase=(0,helpers_1.removeKeyFromUrl)(this.ctx.decodedUrl.root+"/"+this.ctx.href.split(t.config.apiVersion+"/")[1],["top","skip"]),this.linkBase=this.ctx.decodedUrl.root+"/"+this.constructor.name}getKeyValue(t,e){let i=void 0;return t[e]&&(i=t[e]["@iot.id"]||t[e],delete t[e]),i}getKeysValue(e,t){t.forEach(t=>{t=this.getKeyValue(e,t);if(t)return t})}formatDataInput(t){return t}formatReturnResult(t){return{id:void 0,nextLink:t.nextLink||void 0,prevLink:t.prevLink||void 0,body:void 0,total:void 0,...t}}nextLink=t=>{return!(this.ctx.odata.limit<1)&&(0<this.ctx.odata.limit?+this.ctx.odata.limit:+this.ctx.config.nb_page)<=t?`${encodeURI(this.nextLinkBase)}${this.nextLinkBase.includes("?")?"&":"?"}$top=${this.ctx.odata.limit}&$skip=`+(this.ctx.odata.skip+this.ctx.odata.limit):void 0};prevLink=t=>{var e;if(!(this.ctx.odata.limit<1))return e=this.ctx.odata.skip-this.ctx.odata.limit,(this.ctx.config.nb_page&&t>=this.ctx.config.nb_page||this.ctx.odata.limit)&&0<=e?`${encodeURI(this.nextLinkBase)}${this.nextLinkBase.includes("?")?"&":"?"}$top=${this.ctx.odata.limit}&$skip=`+e:void 0};async getAll(){var t=this.ctx.odata.getSql();if(t)switch(this.ctx.odata.returnFormat){case index_1.returnFormats.sql:return this.formatReturnResult({body:t});case index_1.returnFormats.graph:return(0,helpers_1.executeSqlValues)(this.ctx.config,t).then(async t=>0<t[0].length?this.formatReturnResult({body:t[0]}):this.formatReturnResult({body:"nothing"}));default:return(0,helpers_1.executeSqlValues)(this.ctx.config,t).then(async t=>0<t[0]?this.formatReturnResult({id:isNaN(t[0][0])?void 0:+t[0],nextLink:this.nextLink(t[0]),prevLink:this.prevLink(t[0]),body:t[1]}):this.formatReturnResult({body:0==t[0]?[]:t[0]})).catch(t=>this.ctx.throw(400,{code:400,detail:t.message}))}}async getSingle(t){var e=this.ctx.odata.getSql();if(e){if(this.ctx.odata.returnFormat!==index_1.returnFormats.sql)return(0,helpers_1.executeSqlValues)(this.ctx.config,e).then(t=>this.ctx.odata.query.select&&!0===this.ctx.odata.onlyValue?this.formatReturnResult({body:String(t["id"==this.ctx.odata.query.select[0]?"@iot.id":0])}):0<t[0]?this.formatReturnResult({id:+t[0],nextLink:this.nextLink(t[0]),prevLink:this.prevLink(t[0]),body:t[1][0]}):void 0).catch(t=>this.ctx.throw(400,{code:400,detail:t}));return this.formatReturnResult({body:e})}}async addWultipleLines(t){this.ctx.log&&(this.ctx.log.datas={datas:messages_1.infos.MultilinesNotSaved});t=Object(t).map(t=>{t=this.formatDataInput(t);if(t){t=this.ctx.odata.postSql(t);if(t)return t}});const e=[];return await(0,helpers_1.executeSqlValues)(this.ctx.config,t.join(";")).then(t=>e.push(t[0])).catch(t=>{log_1.log.error(logger_1.formatLog.error(t)),this.ctx.throw(400,{code:400,detail:t.detail})}),this.formatReturnResult({body:e})}async post(t){if(t=this.formatDataInput(t)){const e=this.ctx.odata.postSql(t);if(e){if(this.ctx.odata.returnFormat!==index_1.returnFormats.sql)return(0,helpers_1.executeSqlValues)(this.ctx.config,e).then(t=>{if(t[0])return t[0].duplicate&&this.ctx.throw(409,{code:409,detail:this.constructor.name+" already exist",link:`${this.linkBase}(${[t[0].duplicate]})`}),this.formatReturnResult({body:t[0][0],query:e})}).catch(t=>{var e=(0,messages_1.getErrorCode)(t,400);this.ctx.throw(e,{code:e,detail:t.message})});return this.formatReturnResult({body:e})}}}async update(t,e){if(e=this.formatDataInput(e)){const i=this.ctx.odata.patchSql(e);if(i){if(this.ctx.odata.returnFormat!==index_1.returnFormats.sql)return(0,helpers_1.executeSqlValues)(this.ctx.config,i).then(t=>{if(t[0])return this.formatReturnResult({body:t[0][0],query:i})}).catch(t=>{var e=(0,messages_1.getErrorCode)(t,400);this.ctx.throw(e,{code:e,detail:t.message})});return this.formatReturnResult({body:i})}}}async delete(t){t=`DELETE FROM ${(0,index_1.addDoubleQuotes)(this.ctx.model[this.constructor.name].table)} WHERE "id" = ${t} RETURNING id`;if(t){if(this.ctx.odata.returnFormat!==index_1.returnFormats.sql)return this.formatReturnResult({id:await(0,helpers_1.executeSqlValues)(this.ctx.config,t).then(t=>t[0]).catch(()=>BigInt(0))});return this.formatReturnResult({body:t})}}}exports.Common=Common;