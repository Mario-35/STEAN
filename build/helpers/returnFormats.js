"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.returnFormats=void 0;const queries_1=require("../db/queries"),json2csv_1=require("json2csv"),css_1=require("../views/css"),js_1=require("../views/js"),util_1=__importDefault(require("util")),_1=require("."),constants_1=require("../constants"),log_1=require("../log"),defaultFunction=e=>e,defaultForwat=e=>e.toString(),generateFields=e=>{let t=[];var a;return(0,_1.isGraph)(e)&&(a=e.ctx.model[e.parentEntity||e.entity].table,t=[`(SELECT ${a}."description" FROM ${a} WHERE ${a}."id" = ${e.parentId||e.id}) AS title, `]),t},generateGrahSql=e=>{e.intervalColumns=["id","step as date","result"],(0,_1.isGraph)(e)&&e.intervalColumns.push("concat");var t=e.ctx.model[e.parentEntity||e.entity].table,a=e.parentId||e.id;return(0,queries_1.asJson)({query:t===e.ctx.model.Datastreams.table?(0,queries_1.graphDatastream)(t,a,(0,queries_1.interval)(e)):(0,queries_1.graphMultiDatastream)(t,a,e.splitResult,(0,queries_1.interval)(e)),singular:!1,strip:!1,count:!1})},_returnFormats={xlsx:{name:"xlsx",type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",format:defaultFunction,generateSql:defaultForwat},json:{name:"json",type:"application/json",format:defaultFunction,generateSql(e){return e.interval?(0,queries_1.asJson)({query:(0,queries_1.interval)(e),singular:!1,strip:!1,count:!0}):(0,queries_1.asJson)({query:e.toString(),singular:!1,count:!0,strip:e.ctx.config.stripNull,fullCount:!0===e.count?e.toPgQuery()?.count:void 0,fields:generateFields(e)})}},graphDatas:{name:"graphDatas",type:"application/json",format:defaultFunction,generateSql(e){return generateGrahSql(e)}},graph:{name:"graph",type:"text/html;charset=utf8",format(e,t){const r=[],n=[],s=String(100/Object.entries(e).length).split(".")[0];return"object"==typeof e&&Object.entries(e).forEach((e,t)=>{r.push(`<button type="button" id="btngraph${t}" onclick="graph${t}.remove(); btngraph${t}.remove();">X</button>
           <div id="graph${t}" style="width:95%; height:${s}%;"></div>`);var a=e[1].description?""+[e[1].description,e[1].name,e[1].symbol].join('","'):""+e[1].infos.split("|").join(constants_1.DOUBLEQUOTEDCOMA),e=`const value${t} = [${e[1].datas}]; 
          const infos${t} = ["${a}"];`;n.push(` ${e} showGraph("graph${t}", infos${t}, value${t})`)}),`<html lang="fr"> <head>
      <style>${(0,css_1.addCssFile)("dygraph.css")}</style> <!-- htmlmin:ignore --><script>${(0,js_1.addJsFile)("dygraph.js")}</script><!-- htmlmin:ignore -->
      ${r.join("")}
        <script>
        ${(0,js_1.addJsFile)("graph.js")}
          const linkBase = "${t.decodedUrl.root}";
          ${n.join(";")}                             
        </script>`},generateSql(e){return generateGrahSql(e)}},dataArray:{name:"dataArray",type:"application/json",format:defaultFunction,generateSql(e){return(0,queries_1.asDataArray)(e)}},csv:{name:"csv",type:"text/csv",format:e=>{if(e&&"object"==typeof e&&e[0].dataArray)try{var t=new json2csv_1.Parser({delimiter:";",includeEmptyRows:!0,escapedQuote:"",header:!1});return e[0].dataArray.unshift(e[0].component),t.parse(e[0].dataArray)}catch(e){if(e instanceof Error)return log_1.log.errorMsg(e),e.message}return"No datas"},generateSql(e){return(0,queries_1.asDataArray)(e)}},txt:{name:"txt",type:"text/plain",format:e=>0<Object.entries(e).length?util_1.default.inspect(e,{showHidden:!0,depth:4}):JSON.stringify(e),generateSql(e){return(0,queries_1.asJson)({query:e.toString(),singular:!1,strip:!1,count:!1})}},sql:{name:"sql",type:"text/plain",format:defaultFunction,generateSql:defaultForwat},html:{name:"html",type:"text/html;charset=utf8",format:defaultFunction,generateSql:defaultForwat},css:{name:"css",type:"text/css;charset=utf8",format:defaultFunction,generateSql:defaultForwat},js:{name:"js",type:"application/javascript;charset=utf8",format:defaultFunction,generateSql:defaultForwat},png:{name:"png",type:"image/png",format:defaultFunction,generateSql:defaultForwat},jpeg:{name:"jpeg",type:"image/jpeg",format:defaultFunction,generateSql:defaultForwat},jpg:{name:"jpg",type:"image/jpeg",format:defaultFunction,generateSql:defaultForwat},icon:{name:"icon",type:"image/x-icon",format:defaultFunction,generateSql:defaultForwat},ico:{name:"ico",type:"image/x-icon",format:defaultFunction,generateSql:defaultForwat},xml:{name:"xml",type:"application/xml",format:defaultFunction,generateSql:defaultForwat}};exports.returnFormats=Object.freeze(_returnFormats);