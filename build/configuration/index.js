"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.serverConfig=void 0;const constants_1=require("../constants"),helpers_1=require("../helpers"),messages_1=require("../messages"),helpers_2=require("../db/helpers"),__1=require(".."),enums_1=require("../enums"),fs_1=__importDefault(require("fs")),util_1=__importDefault(require("util")),update_json_1=__importDefault(require("./update.json")),postgres_1=__importDefault(require("postgres")),triggers_1=require("../db/createDb/triggers"),logger_1=require("../logger"),log_1=require("../log"),createDb_1=require("../db/createDb"),dataAccess_1=require("../db/dataAccess");class Configuration{static configs={};static filePath;static jsonConfiguration;static ports=[];static queries={};constructor(e){process.stdout.write(`${(0,constants_1.color)(31)} ${"=".repeat(24)} ${(0,constants_1.color)(36)} ${`START ${constants_1.APP_NAME} version : ${constants_1.APP_VERSION} [${constants_1.NODE_ENV}]`} ${(0,constants_1.color)(37)} ${(new Date).toLocaleDateString()} : ${(new Date).toLocaleTimeString()} ${(0,constants_1.color)(31)} ${"=".repeat(24)}${(0,constants_1.color)(0)}\n`),Configuration.filePath=e.toString(),(0,helpers_1.isTest)()&&this.readConfigFile()}readConfigFile(e){try{var t=e||fs_1.default.readFileSync(Configuration.filePath,"utf8");Configuration.jsonConfiguration=JSON.parse((0,helpers_1.decrypt)(t)),this.validJSONConfig(Configuration.jsonConfiguration)?(Object.keys(Configuration.jsonConfiguration).forEach(e=>{Configuration.configs[e]=this.formatConfig(e)}),this.createConfigTest()):(log_1.log.error(messages_1.errors.configFileError),process.exit(112)),"production"===process.env.NODE_ENV?.trim()&&"."!=t[32]&&this.writeConfig()}catch(e){log_1.log.error("Config Not correct",e.message),process.exit(111)}}configFileExist(){return!!fs_1.default.existsSync(Configuration.filePath)}async createConfigTest(){var e;(0,helpers_1.isTest)()||((e=Configuration.configs[constants_1.ADMIN]).name=constants_1.TEST,e.pg.database=constants_1.TEST,e.nb_page=1e3,e.extensions=["base","multiDatastream","lora","logs"],e.canDrop=!0,e.logFile="",e.connection=void 0,Configuration.configs[constants_1.TEST]=this.formatConfig(e))}getInfos=(e,t)=>{var o=e.request.headers["x-forwarded-proto"]?e.request.headers["x-forwarded-proto"].toString():Configuration.configs[t].forceHttps&&!0===Configuration.configs[t].forceHttps?"https":e.protocol;let r=e.request.headers["x-forwarded-host"]?o+"://"+e.request.headers["x-forwarded-host"].toString():e.request.header.host?o+"://"+e.request.header.host:"";r.includes(t)||(r+="/"+t);e=Configuration.configs[t].apiVersion;return{protocol:o,linkBase:r,version:e,root:"test"===process.env.NODE_ENV?.trim()?"proxy/"+e:r+"/"+e,model:`https://app.diagrams.net/?lightbox=1&edit=_blank#U${r}/${e}/draw`}};getAllInfos(t){const o={};return this.getConfigs().forEach(e=>{o[e]=this.getInfos(t,e)}),o}getConfig(e){return Configuration.configs[e]}getConfigs(){return Object.keys(Configuration.configs).filter(e=>e!==constants_1.ADMIN)}validJSONConfig(e){return!!e.hasOwnProperty(constants_1.ADMIN)&&!!e[constants_1.ADMIN].hasOwnProperty("pg")&&!!(e[constants_1.ADMIN][["pg"]].hasOwnProperty("host")&&e[constants_1.ADMIN][["pg"]].hasOwnProperty("user")&&e[constants_1.ADMIN][["pg"]].hasOwnProperty("password")&&e[constants_1.ADMIN][["pg"]].hasOwnProperty("database"))}writeConfig(){const t={};return Object.entries(Configuration.configs).forEach(([e,o])=>{t[e]=Object.keys(o).filter(e=>"db"!==e&&"_"!=e[0]).reduce((e,t)=>(e[t]=o[t],e),{})}),fs_1.default.writeFile(Configuration.filePath,!0===(0,helpers_1.isProduction)()?(0,helpers_1.encrypt)(JSON.stringify(t,null,4)):JSON.stringify(t,null,4),e=>{if(e)return log_1.log.error(logger_1.formatLog.error(e)),!1}),!0}async executeMultipleQueries(t,e,o){return await(0,helpers_1.asyncForEach)(e,async e=>{await exports.serverConfig.connection(t).unsafe(e).catch(e=>(log_1.log.error(logger_1.formatLog.error(e)),!1))}),log_1.log.create(o+` : [${t}]`,constants_1._OK),!0}async executeQueries(t){try{await(0,helpers_1.asyncForEach)(Object.keys(Configuration.queries),async e=>{await this.executeMultipleQueries(e,Configuration.queries[e],t)})}catch(e){log_1.log.error(e)}return!0}hashCode(e){return e.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0)}connection(e){return Configuration.configs[e].connection||this.createDbConnectionFromConfigName(e),Configuration.configs[e].connection||this.createDbConnection(Configuration.configs[e].pg)}connectionAdminFor(e){var t=Configuration.configs[constants_1.ADMIN].pg;return(0,postgres_1.default)(`postgres://${t.user}:${t.password}@${t.host}:${t.port||5432}/`+constants_1.DEFAULT_DB,{debug:constants_1._DEBUG,connection:{application_name:constants_1.APP_NAME+" "+constants_1.APP_VERSION}})}createDbConnection(e){return(0,postgres_1.default)(`postgres://${e.user}:${e.password}@${e.host}:${e.port||5432}/`+e.database,{debug:constants_1._DEBUG,max:2e3,connection:{application_name:constants_1.APP_NAME+" "+constants_1.APP_VERSION}})}createDbConnectionFromConfigName(e){var t=this.createDbConnection(Configuration.configs[e].pg);return Configuration.configs[e].connection=t}addToQueries(e,t){(0,constants_1.addToStrings)(Configuration.queries[e],t)}clearQueries(){Configuration.queries={}}async relogCreateTrigger(o){return await(0,helpers_1.asyncForEach)((0,triggers_1.triggers)(o),async e=>{const t=e.split(" */")[0].split("/*")[1].trim();await exports.serverConfig.connection(o).unsafe(e).then(()=>{log_1.log.create(`[${o}] `+t,constants_1._OK)}).catch(e=>(log_1.log.error(e),!1))}),!0}async afterAll(){return update_json_1.default&&update_json_1.default.afterAll&&0<Object.entries(update_json_1.default.afterAll).length&&(this.clearQueries(),Object.keys(Configuration.configs).filter(e=>e!=constants_1.ADMIN).forEach(async t=>{update_json_1.default.afterAll.forEach(e=>{this.addToQueries(t,e)})}),await this.executeQueries("afterAll")),update_json_1.default&&update_json_1.default.decoders&&0<Object.entries(update_json_1.default.decoders).length&&(this.clearQueries(),Object.keys(Configuration.configs).filter(e=>e!=constants_1.ADMIN&&Configuration.configs[e].extensions.includes(enums_1.EnumExtensions.lora)).forEach(o=>{Object.keys(update_json_1.default.decoders).forEach(e=>{var t=this.hashCode(update_json_1.default.decoders[e]);this.addToQueries(o,`UPDATE decoder SET code='${update_json_1.default.decoders[e]}', hash = '${t}' WHERE name = '${e}' AND hash <> '${t}' `)})})),await this.executeQueries("decoders"),!0}async init(){if(!0===this.configFileExist()){this.readConfigFile();let t=!0;var e=fs_1.default.createWriteStream(constants_1._ERRORFILE,{flags:"w"});return log_1.log.booting("active error to file",constants_1._ERRORFILE),e.write(`## Start : ${(0,constants_1.TIMESTAMP)()} 
`),await(0,helpers_1.asyncForEach)(Object.keys(Configuration.configs).filter(e=>e.toUpperCase()!==constants_1.TEST),async e=>{try{await this.addToServer(e)}catch(e){log_1.log.error(e),t=!1}}),(0,constants_1.setReady)(t),!0===t&&this.afterAll(),t}return Configuration.ports.includes(8029)||__1.app.listen(8029,()=>{Configuration.ports.push(8029),log_1.log.booting("[33m[First launch][32m "+messages_1.infos.ListenPort,8029)}),!0}getConfigNameFromDatabase(t){if("all"!==t){var e=Object.keys(Configuration.configs).filter(e=>Configuration.configs[e].pg.database===t)[0];if(e)return e;throw new Error(`No configuration found for ${t} name`)}}getConfigForExcelExport=t=>{const o=Object.assign({},Configuration.configs[t].pg);return o.password="*****",["name","apiVersion","port","date_format","webSite","nb_page","forceHttps","highPrecision","canDrop","logFile","alias","extensions"].forEach(e=>{o[e]=Configuration.configs[t][e]}),o};getConfigNameFromName=t=>{if(t){if(Object.keys(Configuration.configs).includes(t))return t;Object.keys(Configuration.configs).forEach(e=>{if(Configuration.configs[e].alias.includes(t))return e})}};getModelVersion=e=>{switch(e){case"v1.1":case"1.1":return enums_1.EnumVersion.v1_1;default:return enums_1.EnumVersion.v1_0}};formatConfig(e,t){"string"==typeof e&&(t=e,e=Configuration.jsonConfiguration[e]);var o=t||(e.pg&&e.pg.database?e.pg.database:"ERROR"),r=e.extensions?["base",...String(e.extensions).split(",")]:["base"],s=o===constants_1.ADMIN?enums_1.EnumVersion.v1_1:String(e.apiVersion).trim(),o={name:o,port:o===constants_1.ADMIN?e.port||8029:e.port||Configuration.configs[constants_1.ADMIN].port||8029,pg:{host:e.pg&&e.pg.host?e.pg.host:"ERROR",port:e.pg&&e.pg.port?e.pg.port:5432,user:e.pg&&e.pg.user?e.pg.user:"ERROR",password:e.pg&&e.pg.password?e.pg.password:"ERROR",database:t&&"test"===t?"test":e.pg&&e.pg.database?e.pg.database:"ERROR",retry:e.retry?+e.retry:2},apiVersion:this.getModelVersion(s),date_format:e.date_format||"DD/MM/YYYY hh:mi:ss",webSite:e.webSite||"no web site",nb_page:e.nb_page?+e.nb_page:200,forceHttps:(0,helpers_1.stringToBoolean)(e.forceHttps),stripNull:(0,helpers_1.stringToBoolean)(e.stripNull),alias:e.alias?(0,helpers_1.unikeList)(String(e.alias).split(",")):[],extensions:r,highPrecision:(0,helpers_1.stringToBoolean)(e.highPrecision),canDrop:(0,helpers_1.stringToBoolean)(e.canDrop),users:(0,helpers_1.stringToBoolean)(e.users,!0),logFile:e.log||"",connection:void 0};if(Object.values(o).includes("ERROR"))throw new TypeError(`${messages_1.errors.inConfigFile} [${util_1.default.inspect(o,{showHidden:!1,depth:null})}]`);return o}async addConfig(e){try{var t=this.formatConfig(e);return Configuration.jsonConfiguration[t.name]=t,fs_1.default.writeFile(Configuration.filePath,(0,helpers_1.encrypt)(JSON.stringify(Configuration.jsonConfiguration,null,4)),e=>{if(e)return log_1.log.error(logger_1.formatLog.error(e)),!1}),Configuration.configs[t.name]=this.formatConfig(t),await this.addToServer(t.name),this.writeConfig(),(0,helpers_1.hidePassword)(t),t}catch(e){}}async addToServer(o){return await this.isDbExist(o,!0).then(async e=>{await dataAccess_1.userAccess.post(o,{username:Configuration.configs[o].pg.user,email:"default@email.com",password:Configuration.configs[o].pg.password,database:Configuration.configs[o].pg.database,canPost:!0,canDelete:!0,canCreateUser:!0,canCreateDb:!0,superAdmin:!1,admin:!1}),log_1.log.booting(`[37mDatabase => ${o}[39m on line`,e?constants_1._WEB:constants_1._NOTOK);const t=Configuration.configs[o].port;return 0<t&&(Configuration.ports.includes(t)?log_1.log.booting(`[35m[${o}][32m `+messages_1.infos.addPort,t):__1.app.listen(t,()=>{Configuration.ports.push(t),log_1.log.booting(`[33m[${o}][32m `+messages_1.infos.ListenPort,t)})),e}).catch(e=>{log_1.log.error(messages_1.errors.unableFindCreate,Configuration.configs[o].pg.database),log_1.log.error(e),process.exit(111)}),!1}async tryToCreateDB(e){return log_1.log.booting("Try create Database",Configuration.configs[e].pg.database),(0,helpers_2.createDatabase)(e).then(async()=>(log_1.log.booting(`${messages_1.infos.db} ${messages_1.infos.create} [${Configuration.configs[e].pg.database}]`,constants_1._OK),this.createDbConnectionFromConfigName(e),!0)).catch(e=>(log_1.log.error((0,messages_1.msg)(messages_1.infos.create,messages_1.infos.db),e.message),!1))}async isDbExist(o,r){return log_1.log.booting(messages_1.infos.dbExist,Configuration.configs[o].pg.database),this.connection(o)`select 1+1 AS result`.then(async()=>{const e=(await this.connection(o)`SELECT array_agg(table_name) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME LIKE 'temp%';`)[0].array_agg;if(null!=e&&log_1.log.booting(`delete temp tables ==> [33m${o}[32m`,await this.connection(o).begin(t=>{e.forEach(async e=>{await t.unsafe("DROP TABLE "+e)})}).then(()=>constants_1._OK).catch(e=>e.message)),update_json_1.default.triggers&&!0===update_json_1.default.triggers&&o!==constants_1.ADMIN&&await this.relogCreateTrigger(o),update_json_1.default&&update_json_1.default.beforeAll&&0<Object.entries(update_json_1.default.beforeAll).length&&update_json_1.default&&update_json_1.default.beforeAll&&0<Object.entries(update_json_1.default.beforeAll).length)try{Object.keys(Configuration.configs).filter(e=>e!=constants_1.ADMIN).forEach(t=>{update_json_1.default.beforeAll.forEach(e=>{this.addToQueries(t,e)})}),await this.executeQueries("beforeAll")}catch(e){log_1.log.error(logger_1.formatLog.error(e))}return!0}).catch(async e=>{let t=!1;return"28P01"===e.code?!1===(t=await this.tryToCreateDB(o))&&log_1.log.error(logger_1.formatLog.error(e)):"3D000"===e.code&&1==r?(0,helpers_1.isTest)()||o!==constants_1.TEST?t=await this.tryToCreateDB(o):await(0,helpers_2.createService)(createDb_1.testDatas):log_1.log.error(logger_1.formatLog.error(e)),t})}}exports.serverConfig=new Configuration(__dirname+`/${constants_1.NODE_ENV}.json`);